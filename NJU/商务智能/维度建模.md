# 维度建模

### 1、事实表

- 这是维度建模的核心和基本表
- 每一个事实表对应着一个或者若干个“度量值”
  - 度量值是事实表的核心
  - 通过事实表来记录维度值与度量值之间的关系
- 事实表中一行对应一个度量值
  - 事实表中所有度量值都必须有相同的粒度
- 事实表中的关键字
  - 每个事实表都会有两个或两个以上的foreign key
  - 通过**外关键字**建立**事实表和维度表的关系**
    - **维度表**是来存取事实表中的**度量值**的
  - 可以由**外关键字**的组合构成**事实表**的**主关键字primary key**

### 2、度量值

- 常用度量值：数值类型
- 通常是可以连续取值的量
- 三种类型
  - 可做加法运算
  - 可以沿着某个维度做加法
  - 不能做加法运算

### 3、维度表

- 是事实表的入口，为用户提供了使用数据仓库的接口
- 维度表中的维度属性，通常用于定义事实表上的查询条件，也可以用作定义报表和统计查询的列
- 维度表的定义：**<u>尽可能多的列，相对于事实表较少的行</u>**

### 4、维度属性

- 通常是文本或者离散数据
- 尽量少使用编码属性？？？？
- **维度属性**与**度量值**的区别
  - 维度属性：离散/取值不多；属性不变/很少产生变化/从不参与统计计算，但经常用于查询条件
  - 度量值属性：有许多取值，可以参加统计运算

### 5、事实表和相关维度表的连接

- 一个每日销售情况的事实表，有很多外关键字
- 每个外关键字连接到其他维度表，比如日期关键字连接到日期维度



**<u>维度建模，参考：“数据仓库生命周期工具箱：设计、开发和部署数据仓库的专家方法”</u>**



### 6、维度建模的设计过程

- 选取要建模的业务处理过程（这里肯定是分析型）
  - 如：什么样的促销条件下，在什么样的日子里，在什么商店，销售什么样的商品
- 定义业务处理的粒度
  - 事实表每行度量值的取值粒度
  - 如：以单个商品条目为粒度
- 选择事实表中的维度
  - 如：零售事务的事实表中，有日期维度、产品维度、促销维度、商场维度
- 选择事实表中的度量值
  - 可以有多个度量值
  - 以分析对象为依据
  - 首先确定事实：零售事务事实表中，有销售量、销售额、成本额、**毛利润金额**这些事实
    - 注意：**毛利润金额** 是可以通过计算而获得的可加性度量值，可以物理存在事实表里
    - 而没有可加性的计算结果（不可加事实），应该由访问过程中进行计算，比如**单价，存在产品维度表**
  - 下面维度设计
    - 日期维度
      - 每个数据仓库都要具备，可以事先建立5-10年的日期维度值
      - 属性可以有：日期关键字、编号、年月、日历季度、日历年、财政周、节假日提示周日提示符...
      - 这个日期维度表，要**尽可能详尽**。**日历的逻辑应该由维度表解决，而不是代码解决**
        - 因为：季节、假日这些非标准日历，就应该放入维度表
    - 产品维度
      - 注意，可以将**重复的低粒度值**保存在主维度表
        - 一方面因为相对于事实表，维度表空间需求要**简单很多**
        - 另一方面规范化这些值，再放入不同的表，做不到**简单化和高性能**
      - 包含两类属性
        - 产品的多级体系划分属性
          - SKU编号--小类描述--大类描述--部门描述
          - 每一级都是多对一的关系，于是构成关于商品的**分类体系**
          - （于是就可以进行**下钻**两层）
            - 原来看到：面包房，销售额xxx
            - 现在，面包房，炸薯条，销售额xx; 面包房，软糕点，销售额xx
        - 其他描述属性
          - 包装属性、脂肪含量...
          - **不是产品体系组成部分**，可以和**产品体系划分属性，组合**在一起，进行有意义分析应用
          - (于是可以通过脂肪含量这个属性，对面包房进行划分，下钻一层)
            - 面包房，无脂，销售额xx
      - 作为属性或者事实的数字值，比如价格
        - 如果价格变化缓慢，对不同度量时间没什么影响，放入维度属性
        - 如果用于计算目的，比如做价格变化分析，则应该是事实表
    - 商场维度
      - 销售面积属性
        - 放在商场维度表中，是商场的一个不变属性
      - 首次开业日 和 最后一次重修日期 属性
        - 取值来自前面日期维度表的视图
        - 采用**维度支架**实现
    - 促销维度：分析师希望确定某个**促销是否有效**
      - 对促销活动怎么**评判**？
        - 商品的销售分析
          - 促销期间是否增长；促销前后的变化
        - 相邻或者同类的其他商品的销售，是否出现相应的情况：会不会一个商品销售好了，相邻的商品销量却显著降低（**销售侵蚀**）
        - 与促销商品同类的所有商品的销售，是否出现总体增长
        - 促销是否盈利，综合考虑促销的靠小、销售侵蚀等
      - 处理各种**不同的促销形式**
        - 比如有：临时降价、报纸广告、礼券等
        - 可以**每一种类型的促销活动**，放一个**单独的促销维度表**
        - 也可以**所有促销活动合在一个促销维度表**中
      - 维度的组合
        - 参与组合的维度高度相关
        - 组合起来的维度能够**高效地进行浏览**
      - 维度的分散
        - 当用户分开考虑时，分开的维度更加**容易理解**
        - 独立维度的管理，对于组合维度来说，更加**直截了当**
      - 有一些商品销售**事实**，**不在促销的范围**
        - 那么就在促销维度表中，定义一个**<u>特殊的行</u>**
        - 事实表中，所有**没有参与促销活动的行（即销售事实）**
          - 都引用这个**<u>特殊的行</u>**，来表示该维度值，对**当前事实表的行**不可用
      - 还有一类问题需要确定，**<u>什么样的促销产品还没有卖出去</u>**
        - 这个问题在上述零售营销模型回答不了
          - 因为销售事实表仅仅**记录实际卖出去的部分**，不包括没有销售行为的产品
        - 于是维护另一个**非事实型事实表**，来记录**每天每件商品**的**促销活动**
          - 为**每天每个商场**的**每个促销产品**，创建一行
          - 叫“**促销范围事实表**”
          - 不存在度量指标，仅仅记录各个维成员之间的关系
          - **<u>粒度不同于之前的事务事实表</u>**
          - 对**两个表粒度显著差别**解释
            - 为了确定当前促销的产品哪些没有卖出去，我们只需要知道键之间的关系，并**为每个促销的产品加载一行，无论产品是否卖出**
              - 这一点与销售无关
    - 退化维度
      - 对应维度表为空，具体的**维度值**直接放在**事实表**中
      - 这里是**POS事务编号**，还可以是订单编号、发票编号等
      - 退化维度，是没有对应维度表的维度键

### 7、模型的演化

- 新的维度属性，如产品的全新描述属性
  - 加新维度属性时，之前没加上的产品，对应部分可以用“不可用”填充
- 新的维度：如会员、店员等
  - 则要加入**新的维度表**
  - 在事实表中加入**新的外关键字**
- 新的度量值事实
  - 添加新的度量值属性
  - 需要考虑事实表粒度
- 维度变得具有更多的粒度性
  - POS事物数据，在最初建模的时候，就是**以最细粒度即便构建的**
    - 于是增加维度，可以**方便地使用细粒度**，不必改变维度键或者事实
  - 如果刚开始定义的**粒度过大，则很难合并到新加入的维度**
    - **过早聚集和汇总，限制了补充维度的能力**
  - 可能会带来**新粒度层次上的事实表**，于是就要同时建立新的维度表和事实表
  - 总之**<u>事实表的粒度设计，将影响到是否易于加入新的维度</u>**

- **<u>全新的数据源</u>**加入，会牵涉到现存的维度，以及不可预见的新维度
  - 新数据源几乎总是拥有自己的粒度和维度
  - 可以建立新的事实表和维度表

### 8、维度的规范化处理

- 我们想打破传统建模规则，更加关注易用性和性能，而不是事物处理的效率

##### 规范化维度的雪花模式

- 消除了冗余
- 但是**易用性和性能不够**
  - 违背维度建模：**简单化**的主要目标
  - 大量表和连接操作，导致查询**缓慢**
  - 磁盘空间节省得不是很明显，为节省空间而做规范化，是**浪费时间**
  - **低纬度**浏览能力
  - 不支持物理加速技术
- 一般不推荐使用雪花模型，但是某些场景可以用
  - 比如为了某个事实表 范围之内的维度，建立**支架维度**
    - 为产品维度，添加一个日期的FK
    - 只有业务希望按照非标准的日历属性（财务周期这种），过滤或分组时，这种日期属性构建支架才有意义。否则只需要按照一个标准日期类型对待
  - 尽管可以使用支架，但是出于潜在性能考虑，尽量不要大量使用

##### 蜈蚣事实表

- **包含了太多维度表**的事实表设计
- 于是事实表需要更多磁盘空间
- 注意事实表是最大的表，和维度表不是一个量级的
  - 蜈蚣事实表大量的连接，对**性能和可用性都不好**
- 如果有太多的维度，应该考虑**合并相关联的维度**，例如层次级别，或者同级相关性
  - 将**统一层次**的元素，表示为**事实表中的不同维度**，是维度建模常见错误

### 9、维度的关键字处理

- **避免直接使用操作型数据**，作为维度表和事实表的，主关键字和外关键字
  - 缓冲操作型数据变化，对数据仓库数据的影响
  - 性能优势
  - 操作型数据可能无法作为关键字
  - 日期维度有特殊要求
    - SQL日期不能为 待定 或 不可用
    - 日期维度的代理关键字，应当按照**有意义的连续次序进行分配**
      - 1月1日作为1，2月1日作为32
      - 允许在日期关键字基础上做物理分区和索引
      - YYYY-MM-DD不合适，他对过滤不是很好
        - 但是可以用于分区事实表
  - 历史一致性

### 10、市场篮子分析

- （网上找的）市场篮子实际就是，顾客在超级市场内，一次购买商品的总称
  - 市场篮子分析就是通过每个市场篮子的销售所显示的信息，了解顾客的购买行为
- 通过事实表的抽取
  - 从零售事实表中，抽取形成新的事实表，以实现新的分析应用
  - 之前POS事务事实表中，**粒度：每行都是一个事务分裂项**
  - 现在有了POS市场篮子事实表，**粒度：每行都是商场每天促销卖出的每对产品**：产品A、产品B
    - 如果有N个产品，就有N*(N-1)中组合
  - 怎么分析？
    - 领域相关知识支持
    - 层次性分析
      - 类别、商标...产品，从高层向底层去



