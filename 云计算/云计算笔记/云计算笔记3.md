# 4、存储技术

- 目的：对外提供存储服务，作为构建上层应用的基础
- 要求：海量数据，高扩展性、考虑不可靠的硬件
- 存储数据类型：文件（图像文本视频），数据表，对象

#### 处理大小不一的文件

- 分块：分块大小、管理、出错（使用冗余）、分块数据一致性

#### 分块的管理

##### 1、主从模式

- 优点：方便添加服务器和负载平衡，不存在一致性问题
- 缺点：单点故障，性能瓶颈

- GFS**<u>（lecture 04 ppt7有图片）</u>**
  - 文件分为固定大小Chunk存储
  - 冗余提高可靠性
  - 通过“单个”master协调数据访问、元数据存储
  - 无缓存
- HDFS**<u>（lecture 04 ppt8有图片）</u>**
  - 一个NameNode: 管理文件系统的元数据
  - 多个DataNode: 存储实际的数据

##### 2、无中心模式

- 优点：不存在单点故障和性能瓶颈
- 缺点：负载均衡和一致性问题
- Dynamo**<u>（lecture 04 ppt9有图片）</u>**
  - 虚拟节点
  - Hash值确定存放位置

#### 分块出错

##### 1、单个分块出错

- 校验码：每个块进一步分成小块，每个小块一个校验码
- Merkle哈希树技术
  - 叶节点是存储数据的哈希值，父节点是所有子节点的哈希值

##### 2、服务器出错

- 主从模式
  - 主节点出错：无响应，或者通过日志容错
  - 块服务器出错：恢复服务器上块，管理软件监测，心跳机制
- 无中心模式shi
  - 闲聊机制：每个服务器定期随机向另一个服务器发送消息
  - 恢复服务器上每个块

#### HDFS

##### 1、可靠性保障

- 冗余备份和副本存放
- 心跳检测和安全模式：nameNode周期性从每个dataNode接受心跳包(是否死机)和块报告(安全模式下检测)
- 数据完整性检测：将校验和存在隐藏文件
- 空间回收
- 元数据备份：利用映像文件和日志

##### 2、性能提升

- 副本选择：使用距离程序最近的副本进行读操作
- 负载均衡：当磁盘空间很少时自动迁移数据到其他节点
- 客户端缓存：临时文件超过64MB时才正式写入数据
- 流水线复制：客户端->第一个dataNode->第二个dataNode->第三个dataNode

#### 数据一致性

- 强一致模型：任何时刻的数据副本一致
- 最终一致模型：牺牲一致性，提升可靠性可用性
- 数据一致性示例：AWS S3 **<u>（lecture 04 ppt15有图片）</u>**
  - 作用
    - 通过接口将任意类型的数据，临时或者永久存储在服务器上（Dynamo）
    - 特点：可靠、易用、低成本
  - 主要操作（操作目标可以是桶或者对象）
    - get: 获取桶中的对象，获取对象的数据和元数据
    - put: 创新或者更新桶/对象
    - List: 列出桶中所有的键
    - Delete: 删除桶；删除对象
    - Head: 获取对象的元数据
  - 数据安全性
    - 冗余存储，每个数据多副本，不同服务器保存
  - 最终一致模型
    - 当数据被传播到所有节点前，返回原来数据
    - 几种情形：（不想写了）

#### 关系型数据库

##### 面临问题

- 无法支持海量数据快速访问
- 缺少灵活性（可扩展性）
- 非结构化数据处理能力弱
- 存储和维护成本随着数据量增加而增加

##### 解决思路

- 不同数据类型：不考虑存储具体类型
- 可扩展性：非结构化数据存储机制
- 分块实现：分割子表，或其他易于分割的形式
  - 可以解决数据稀疏的问题

#### 数据模型

##### 1、BigTable

- 行：表中数据，根据**<u>行关键字</u>**，词典序排序
- 列：按列族存储，每个族中数据统一类型
- 时间戳：保存不同时期的数据
- 物理划分：表--子表--SSTable文件

##### 2、SimpleDB

- 数据都**UTF-8编码的字符串**存储，字典序查询
- 基本结构：树状结构
  - 域：数据库操作基本单位，查询只能在一个域内进行
  - 条目：域内条目命名唯一，不需要事先定义模式（可能因为是字符串？）
  - 属性：条目的特征
  - 值：允许多值属性
    - 每个属性值不能超过1KB
    - SimpleDB存放指针，指向存放在S3中较大数据
- 采用最终一致性数据模型

##### 3、Microsoft Table

- 账户--table--实体--属性
- 物理划分：partitionKey（Document name）+rowKey（version）唯一标识一个实体
  - 分割时应该考虑负载均衡和高效查询

#### HBase

##### 1、HBase中的区域

- 划分
  - 按水平方式划分，每个区域包含表中一部分行
  - 每个区域随机id，区域内部的行按照行键排序
  - 区域大小超过阈值后，自动分割成两个相同大小区域
- 管理
  - 区域服务器 region server
    - 处理用户读写需求
    - 向主服务器报告状态，取得需要服务的区域
    - 负责维护区域的分割
  - 主服务器 master server
    - 指派区域服务器装载指定区域
    - 恢复失效区域服务器
- HBase区域服务器
  - 存储
    - 每个列族对应一个Hstore
    - 一个Hstore包含多个Map File
  - 写操作
    - 数据线缓存，达到一定数量后批量写入
    - 写数据前“预写”日志，写入完成后在日志标记
    - 一个区域服务器上所有区域同一日志
  - 读操作
    - 先在缓存中查找，命中请求则直接服务
    - 若多个版本，返回最新的
  - 合并
    - 达到周期或者Map File数量超过阈值，会合并；合并与无关的读写请求并发
    - 和读写相关的合并，先挂起读写，等到合并完成
  - 分割
    - 区域超过阈值，对半分割成两个大小相同的区域
    - 由主服务器确定接管的区域服务器
    - 被分割区域通过垃圾回收机制回收
    - 区域服务器在元信息表中生成子表元信息
- HBase元数据表
  - 元数据表
    - 区域元数据存储在另一个区域
      - 区域的唯一标识符是元数据表的行关键字
      - 包括区域中数据起止行、区域状态、区域服务器地址
    - 可包含多个区域
    - 所有元数据区域的元数据，存储在根表中
  - 根表（Root Table）
    - 只包含一个区域
    - 主服务器启动时扫描
      - 扫描根表获得所有元数据区域位置
      - 扫描元数据区域，获得区域的位置，并分配区域服务器
- HBase失效恢复
  - 如果没有心跳，主服务器判定区域服务器失效
  - 主服务器将失效服务器提供服务的区域，重新分配给其他区域服务器
  - <u>**和bigTable区别**</u>
    - <u>**bigtable因为有chubby，所以bigTable中子表服务器即使和主服务器连接断开，仍然可以继续服务**</u>
    - HBase如果断开，主服务器就检测不到心跳

#### 云存储服务

##### 1、是什么

- 专注于向用户提供  以互联网为基础的  在线存储服务
- 用户只需要付费就可以获得服务，无需考虑存储容量、设备类型、数据存储位置、数据可用性、可靠性、安全性等繁琐底层细节

##### 2、基本特征

- 分布于网络（互联网或局域网）
- 易于扩展
- 易于管理

##### 3、推动因素

- 数据量快速增长，个人、企业存储设备无法满足要求
- 数据同步和异地访问：不同设备数据同步，异地工作访问数据
- 数据备份：防止数据丢失

##### 4、影响因素

- 网络带宽：需要大容量数据传输
- 应用存储：通过在存储设备中集成应用软件，提高性能和效率
- 集群技术、分布式文件系统和网格计算：需要实现各个存储设备之间协同工作
- 网络存储安全技术：保证数据传输安全及数据不会丢失
- 存储管理技术：多地域多厂商多硬件设备之间传输管理

##### 5、存在问题

- 客户对云存储和自身需求了解不足
  - 数据备份和容灾的成本
  - 系统是否有“无限”扩展的需求
  - 软硬件升级费用是否有边际效益
  - 存储系统升级是否会产生显著影响
- 市场定位模糊
  - 小型企业承担不了云存储的维护费用
  - 大中型企业不愿舍弃原有IT设备
- 安全感缺失
  - 可控性不强：断网、断电、数据迁移等
  - 法律保护不够：我的数据是否被搜查
- 公有云和私有云之争
  - 公有云：主要做的是数据托管，用户只要承担容量租金和带宽费用，无需硬件技术知识
  - 私有云：所有数据由内部IT员工控制，需要硬件和软件，但不承担存储租金和带宽费用



























