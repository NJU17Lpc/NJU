### 1、基本概念

###### 事实表

- 维度建模的核心和基本表
- 每一个事实表对应一个或若干个“度量值”
  - 通过事实表记录维度值与度量值的关系
- 事实表中一行对应一个度量值
  - 所有度量值必须有相同粒度
  - **<u>粒度划分模型</u>**：事务、周期快照、累积快照

###### 事实表中的度量值

- 常用数值类型，通常可以连续取值，很少用文本形式
- 三种度量值
  - 可做加法运算
  - 可沿着某些维度做加法运算
  - 不能做加法运算：技术统计、平均值、取样

###### 事实表中的关键字

- 每个事实表都有两个或两个以上外关键字
- 借此建立事实表和维表之间联系，从而**<u>通过维表来存取事实表的度量值</u>**
- 可以由**外关键字的组合构成事实表的主关键字**

###### 维度表

- 是事实表的入口，为用户提供了使用数据仓库的接口
- 维度表中的维度属性通常定义事实表上的查询条件，像“列”
- 维度表：包含尽可能多的列，相对较少的行

###### 维度属性

- 通常是文本数据，或者离散数据
- 尽量**减少编码属性**
- 维度属性与度量值区别
  - 度量值：许多取值，可参与统计
  - 维度属性：离散或取值不多的属性；取值不变或很少变化；从**不参与统计计算**，但**常用作查询条件**



### 2、维度建模的设计过程

###### 1、选取要建模的业务处理过程

- 分析需要

###### 2、定义业务处理的粒度

- 事实表中每一行的度量值取值粒度

###### 3、选择事实表中的维度

###### 4、选择事实表中的度量值

- 以分析对象为依据
- 可以有多个度量值

### 3、零售营销的 要点

- 确定事实
  - 计算获得的可加性度量值可以存在事实表：毛利润金额
  - 不可加的计算结果应该在访问过程中计算：毛利润率
- 日期维度
  - 每个数据仓库必须有
  - 该维度表可以事先建立

- 产品维度：存在两类属性
  - 产品的多级体系划分属性
  - 其他描述属性：比如脂肪含量。可以与产品体系划分一起进行有意义分析
- 促销维度
  - 存在很多种促销形式
    - 每类促销活动可以单独形成促销维度表，也可以糅合在一个促销维度表
    - 维度组合，组合起来的维度不会大很多，能高效浏览
    - 维度分散，更容易理解，方便管理
  - 不在促销范围内的销售事实怎么办
    - 促销维度中**定义特殊的行**
    - 所有没有参与促销活动的事实，都引用这个特殊的行，来表示该纬度值不可用
  - 由于表只是记录了卖出去的，**不好回答什么样的促销产品没卖出去**
    - 于是需要一个**非事实型事实表**，记录每天每件商品的促销活动
      - 不存在度量指标，只记录各个维成员的关系
      - 每天每个商场的每个促销产品一行
    - 二者**粒度不同**
  - **<u>退化维度</u>**
    - 维度表为空，具体的维度值直接放在事实表中
    - 比如各种**<u>编号</u>**
- 通过**维度表**中的**维度属性**访问**事实表**
- 模型的演化
  - 加入新的维度属性，加入时间点前的用“不可用”填充
  - 加入新的维度，新维表，新FK
  - 加入新的度量值事实：新的度量值、可能要考虑事实表粒度
  - 模型变得有很多粒度性，可能会有新粒度层次上的事实表
  - 全新数据源加入，会牵涉现存维度和不能预见的新维度
  - **<u>事实表的粒度设计将影响到是否易于加入新的维度</u>**
- 维度的规范化处理
  - 规范化后的好处基本只有节省空间（低纬度浏览能力）
- 维度表中关键字设计
  - **用代理关键字，避免直接用操作型数据**
  - 日期维度有特殊要求
    - SQL日期不能为“日期待定”或者“日期不可用“
    - 日期维度的代理关键字，应该**按照有意义的连续次序**进行分配
    - 不用yyyy-mm-dd，比如1月1号->1,1月2号->2
- 市场篮子分析
  - 不使用OLAP或DM工具
  - 从零售事实表中抽取，形成新的分析应用
    - 从一行对应一个事务，移植到，一行对应一对卖出的产品
    - N个产品 Nx(N-1)种组合

### 4、库存管理的要点

###### 1、值链

- 由企业的关键业务组成
- 确定了企业主体活动的自然逻辑流程
- 每一步业务处理都产生大量周期性事务记录
- DSS首要目标是监控关键处理过程的性能结果
  - 依据每步业务处理的事实表（每一步可以有一个或多个事实表）

###### 2、事实表粒度模型

三种**互补**的：库存事实表**粒度模型**

**<u>都是要按照维度建模的过程做的：业务处理过程、粒度、维度、事实</u>**

- 库存周期快照：定期生成每种商品的库存水平
  - 减少脱销
  - 需要通过产品和商场分析每天库存水平
  - 日期、产品、商场维度作为公共维度，保持一致，也可以引入其他属性
  - **<u>库存周期快照事实表 vs 销售事务事实表</u>**
    - 销售是稀疏的，库存是稠密的
      - 因为销售记录每天实际发生的销售；库存周期快照要记录每天每种商品在每个商场的库存
      - 可以随着**时间推移，降低周期快照的频率**
    - 半加型事实：部分维度上可加----库存量不能跨日期可加
      - 这样就不能简单地用AVG来统计
  - 可以扩充事实表
    - 如库存数量、销售量、成本核算值
    - 但注意**同一张事实表的度量值要有统一的粒度**，不同事实表可以不同粒度
- 库存事务：记录库存水平的主要因素
  - 应对库存周期快照无法提供的分析操作：如具体事务类型
  - 于是每个库存事务对应事实表中的一行
- 库存累积快照：记录每件商品的分发历史
  - 想法：为每种特定商品的入库装运给出相应的一行记录
    - 对产品状态情况的跟踪放在事实表单行记录中，直到离开仓库
  - 特点：
    - 事实表中多个**取值为日期的外关键字**：装箱日期、装运日期、入库日期
    - 需要对事实表中每一行，进行多次访问和修改
    - 很少用于长期运行而需要不断补充的库存处理

###### 3、主题集成

- 为了跨主题范围的数据查看、分析
  - 来自不同主题的度量值，可以组合到单个分析任务
- 方式：使用**共享公共的维度**设计

###### 4、数据库总线结构

- 一种可以按增量开发方式，分步建造企业数据仓库的方法
  - 为DW环境定义标准总线接口，不同开发小组在不同时间实现独立的数据集市。遵循总线接口后，这些独立的数据集市就可以在一起有效共享

- 一组综合的，具有一致性的公共维度
  - 设计出一整套企业范围内，具有统一解释的标准化维度与实施，从而可以对企业数据仓库建设任务合理分解。不同小组分阶段，或并行进行DW建设
  - 采用总线体系结构可以独立于技术手段和数据库平台
- **一致性维度**
  - 是进一步开发总线结构数据仓库系统的基础
    - 有一致的：维度关键字、属性列名字、属性定义、属性值
  - 一致性维度可能意味着：相同的维度表
    - 与他们相连的**事实表**具有完全相同的内容，但**不同的度量值**
    - 物理上可能是同一张表，也可以不同。但要有相同的：**行数**、关键字、属性标签、属性定义、属性值
  - 大多数一致的维度是在**可能的最佳粒度层次**上定义的
    - 说的就是**最细粒度**
  - 原子型维度：在最佳粒度层次上的维度定义
  - 上钻维度
    - 较大粒度，用来**连接较高层次事实表**
  - 不同业务处理的事实粒度不同
  - 两个处于相同细节层次上的维度表，如果他们均是另一个维表的子集，则他们也是一致的
- 一致性事实
  - 指：同样的事实，在**不同的数据备份**中，进行存储的一致性
  - 一般事实表数据不在多个数据备份间明确地进行拷贝
  - 如果事实表存在多个数据备份，那么支撑这些事实的定义和方程必须相同
  - 如果无法使得事实保持一致，那么应该对不同的解释，给予不同的名称

### 5、订单管理

###### 1、事实表的规范化

- 一张事实表的多个度量值分解组装成多个事实表
- 目的：可以连同标识事实类型维度一起，得到**单一的一般性事实**
- 一般不考虑事实表的规范化，**除非不同度量值的计算处于不同的粒度层次上**，那么需要把它们分解到不同事实表
- 事实表粒度越细，则可以提供的分析操作越多
- 如果将粗粒度度量值，分配到细粒度层次上，则可以在细粒度层次上，通过统一粒度层次，建立一张统一的事实表

###### 2、维度设计策略

- 可以和前面维度模型共享**公共维度表**：日期维、产品维、顾客维...（数据仓库总线思想）
- 针对订单管理特殊性，需要多考虑一些问题
  - 日期维度的角色模仿
    - 因为订单事实表中有很多日期类型的外关键字
      - 可以为每个日期FK建立独立日期维表；或所有日期类型FK共享一个物理的日期维表
    - 可以后台维持单一的日期维度表，为每一个日期FK建立一个日期维表上的**<u>视图</u>**：create view xxx
      - 降低存储空间开销，方便实用
  - 维度表的属性体系结构
    - 用于描述维度表中的元组，在不同方面的**描述属性**
- **什么时候单一维度，什么时候分割**
  - 实体之间存在固定的，不随时间变化的、强烈相关的关系时，需要作为单一维度
  - 其他情况下分割
  - 需要考虑维度过多的情况：考虑维度组合
- 退化维度
  - 偶尔用于数据仓库反向链接操作型领域
- 杂项维度
  - 定义好各种维度后，通常会剩下一些**小范围取离散值的指示符与标志**。如果作为事实存放在事实表中，**事实表占用空间过大**；如果单独建立维度表，**维度过多**
    - 这时候可以建立杂项维度，将这些字段简历到一个维度表，保存一个外键。几个字段的不同取值组成一条记录，生成代理键，存入维度表。并将代理键保存到相应事实表中
    - 建议不直接使用所有的组合，而是在抽取的时候遇到新的组合生成记录就好
  - 可以用以维护附在事实行上的自由注释字段
- 多种流通货币
  - 选择一个标准通用货币
  - 建立货币转换事实表，里面有两方汇率兑换率和日期
  - 建立货币维表（角色扮演）
- 粒度不同的标题与分列项事实
  - 订单运费只适用于整份订单
  - 处理：
    - 在**较低层次**事实表中，尽可能包含所有**可用的高层事实**表中的事实
    - 将运费与其他标题级事实，展现在用于整个订购的聚集表中

### 补：三种类型事实表的比较

![image-20191229163922928](C:\Users\刘鹏程12138\AppData\Roaming\Typora\typora-user-images\image-20191229163922928.png)

- 数据仓库环境中，有对实时业务数据访问的需求：**<u>实时分区</u>**
  - 包括静态数据仓库最后一次更新以来出现的所有行为
  - 尽可能无缝连接到静态数据仓库事实表的粒度与内容
  - 能轻松地建立索引，便于吸纳新数据
- 三种不同类型的实时分区
  - 事务粒度--当天的记录（并非统计结果）
    - 实时分区有与他的支撑静态事实表，有完全相同的维度
    - 可能不完全建立索引
    - 避免包含聚集值
  - 周期快照--最近一个周期内的统计结果
    - 实时分区是当前正在开发的月份映像，半加或者全加事实随着不断调整
    - 月份结束时累计的实时分区，作为最新月份加载到静态仓库
  - 累积快照--只记录最近被更新的项
    - 实时分区只包含当天更新的分列项
    - 当天结束时，实时分区包含了需要写到事实表上记录的最新版本
    - 无需索引和聚集

### 6、客户关系管理

CRM客户关系管理：基础是一致性的公共客户维度

- 客户维度特点：特别多的元组、特别多的属性、快速变化的维度

###### 1、低基数属性集的维度支架

- 就是说这个维度属性**只有少数几个取值**
- 支架维度
  - 将一组低基数属性单独构成客户的一个维度（支架维度），于是整个模型雪花状
  - 支架维度中的数据一般是从外部数据提供者那里获得的：比如县人口统计支架维度
- 客户维度与支架维度有悬殊的粒度，有不同的加载次数，可以节省维度表存储空间
  - 如果坚持用星型结构，可以通过视图来隐藏维度支架

###### 2、大型变化客户维度

- 部分维度属性是随着时间变化的，如果只是简单修正变化维度属性：只保留该维度的当前值，会影响对事实表中该维度属性所对应的的事实数据元组的访问，无法根据维度属性值的变化情况来分析处理
- 维度表的划分
  - 稳定维度：不用额外处理了
  - 渐变维度：不同类型对应处理办法
    - 改写属性值：容易实现，但不能维护旧属性的历史数据
    - 添加维度行：
      - 准确跟踪渐变属性的**主要方法**，引入新的行来反映新的属性值
      - 增加了维度行的膨胀
      - 可以引入生效或者截止日期
    - 添加维度列
      - 使用维度列保存旧的属性值：（部门，前部门）
      - 不适合跟踪维度属性大量变化
    - 1+2+3：
      - 上面三种一起用
  - 快变维度：处理方法
    - 微型维度
      - 分析频率高或者变化频率大的属性，拆成独立的微型维度
        - 年龄、收入水平等
        - 可以将微型维度独立于客户维度之外，直接附加在事实表上。基于微型维度属性分析操作时，可以避开数量庞大的客户维度
    - 预设波段
      - 收入与购买总额等不断变化的属性，应该被转换成呈波段分布的范围（就是离散化处理），只能在数目相当小的离散值中取值，减少维度表中数据量

















